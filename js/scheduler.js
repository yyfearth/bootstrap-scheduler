// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var DAY_SPAN, Scheduler;

  DAY_SPAN = 86400000;

  Scheduler = (function() {
    function Scheduler(options) {
      var opt;
      this.options = options != null ? options : {};
      opt = this.options;
      if (opt.selectableFromNow == null) {
        opt.selectableFromNow = true;
      }
      this.$el = $(opt.el);
      if (!this.$el.length) {
        throw 'cannot find el ' + opt.el;
      }
      this.el = this.$el[0];
      this.$left = this.$el.find('.datepickers>.left');
      this.$right = this.$el.find('.datepickers>.right');
      this.$els = this.$left.add(this.$right).datepicker({
        startDate: opt.selectableFromNow ? 'now' : null,
        todayHighlight: true,
        keyboardNavigation: false
      });
      this.left = this.$left.data('datepicker');
      this.right = this.$right.data('datepicker');
      this.$list = this.$el.find('ul.date-list');
      this.$total = this.$el.find('.total');
      this._disabled = {};
      this._selected = {};
      this._bind();
      if (opt.selection) {
        this.setSelection(opt.selection);
      }
      if (opt.disabled) {
        this.setDisabled(opt.disabled);
      }
      this.go(opt.viewDate);
    }

    Scheduler.prototype._bind = function() {
      var dragging_start,
        _this = this;
      this.$els.on('mousewheel DOMMouseScroll', function(e) {
        var datepicker;
        e.preventDefault();
        e = e.originalEvent;
        datepicker = $.data(this, 'datepicker');
        if (datepicker != null) {
          datepicker.go(e.wheelDelta > 0 || e.detail < 0 ? -1 : 1);
        }
        return false;
      });
      this.$els.on({
        changeMonth: function(e) {
          return _this.showSelected(e.target);
        },
        changeDate: function(e) {
          _this.toggleDate(e.date);
          _this.showSelected();
          return _this.showSelected(e.target, 1);
        }
      });
      dragging_start = null;
      this.$els.on('mousedown', '.day', function() {
        dragging_start = this;
        return true;
      });
      this.$els.on('mouseenter', '.day', function(e) {
        if (dragging_start) {
          _this.highlight(dragging_start, e.target);
        }
        return true;
      });
      this.$els.on('mouseup', '.day', function(e) {
        var func;
        if (dragging_start && dragging_start !== e.target) {
          func = e.altKey ? _this.removeDate : _this.addDate;
          _this.selectRange(dragging_start, e.target, func.bind(_this));
        }
        dragging_start = null;
        return true;
      });
      this.$el.on('mouseleave', function() {
        _this.highlight(null);
        dragging_start = null;
        return true;
      });
      this.$el.find('.btn-today').click(function() {
        return _this.go();
      });
      return this.$el.find('.btn-clean').click(function() {
        return _this.clean();
      });
    };

    Scheduler;

    Scheduler.prototype._getDateKey = function(date) {
      return date.toISOString().slice(0, 10);
    };

    Scheduler.prototype._betweenDate = function(from, to, pass, func) {
      var cur, p, _getTS;
      _getTS = function(date) {
        if (date.dataset != null) {
          return new Date($.data(date, 'date-key')).getTime();
        } else if (date instanceof Date) {
          return date.getTime();
        } else if (typeof date === 'number') {
          return date;
        } else {
          return new Date(date).getTime();
        }
      };
      from = _getTS(from);
      to = _getTS(to);
      if (from > to) {
        cur = to;
        to = from;
      } else {
        cur = from;
      }
      if (pass) {
        while (cur <= to) {
          func(new Date(cur));
          cur += DAY_SPAN;
        }
        return null;
      } else {
        p = [];
        if (to - cur >= DAY_SPAN) {
          while (cur <= to) {
            p.push(func(new Date(cur)));
            cur += DAY_SPAN;
          }
        }
        return p;
      }
    };

    Scheduler.prototype.showSelected = function(target, delay) {
      var _t,
        _this = this;
      if (target == null) {
        this.showSelected(this.$left[0], delay);
        this.showSelected(this.$right[0], delay);
      } else {
        _t = $.data(target, '_refresh_sel_t');
        if (_t) {
          _t = clearTimeout(_t);
        }
        if (delay < 10) {
          this._showSelected(target);
        } else {
          _t = setTimeout(function() {
            _this._showSelected(target);
            return $.data(target, '_refresh_sel_t', null);
          }, delay);
        }
        $.data(target, '_refresh_sel_t', _t);
      }
      return this;
    };

    Scheduler.prototype._showSelected = function(target) {
      var count, date, datepicker, formatDate, frag, last, selection, spanFrom, _append, _disabled, _i, _len, _selected,
        _this = this;
      datepicker = $.data(target, 'datepicker');
      _selected = this._selected;
      _disabled = this._disabled;
      $(target).find('.day').each(function() {
        var el, key;
        el = $(this);
        if (!el.is('.disabled')) {
          key = el.data('date-key');
          if (_disabled.hasOwnProperty(key)) {
            return el.addClass('disabled selected');
          } else if (_selected.hasOwnProperty(key)) {
            return el.addClass('active');
          } else {
            return el.removeClass('active');
          }
        }
      });
      if (this.$list.is(':visible')) {
        frag = document.createDocumentFragment();
        formatDate = $.fn.datepicker.DPGlobal.formatDate;
        spanFrom = null;
        last = new Date(0);
        _append = function(spanFrom, last) {
          var str;
          if (spanFrom) {
            str = formatDate(spanFrom, 'M dd, yyyy', 'en');
            if (spanFrom !== last) {
              str += ' ~ ' + formatDate(last, 'M dd, yyyy', 'en');
            }
            return $("<li>" + str + "</li>").appendTo(frag);
          }
        };
        selection = this.getSelection();
        count = selection.length;
        if (count) {
          this.$total.text("(" + count + " " + (count > 1 ? 'days' : 'day') + " selected)");
          for (_i = 0, _len = selection.length; _i < _len; _i++) {
            date = selection[_i];
            if (date.getTime() - last.getTime() > DAY_SPAN) {
              _append(spanFrom, last);
              spanFrom = date;
            }
            last = date;
          }
          _append(spanFrom, last);
        } else {
          $("<li>(Empty)</li>").appendTo(frag);
          this.$total.empty();
        }
        this.$list.empty().append(frag);
      }
      return this;
    };

    Scheduler.prototype.toggleDate = function(date) {
      var key;
      if (!(date instanceof Date)) {
        throw 'invalid date which is not a Date object';
      }
      key = this._getDateKey(date);
      if (this._selected.hasOwnProperty(key)) {
        delete this._selected[key];
      } else {
        this._selected[key] = date;
      }
      return this;
    };

    Scheduler.prototype.addDate = function(date) {
      var key;
      if (!(date instanceof Date)) {
        throw 'invalid date which is not a Date object';
      }
      key = this._getDateKey(date);
      if (this._disabled.hasOwnProperty(key)) {
        console.warn('date want to add is disabled ' + key);
      } else {
        this._selected[key] = date;
      }
      return this;
    };

    Scheduler.prototype.removeDate = function(date) {
      var key;
      if (!(date instanceof Date)) {
        throw 'invalid date which is not a Date object';
      }
      key = this._getDateKey(date);
      delete this._selected[key];
      return this;
    };

    Scheduler.prototype.selectRange = function(from, to, addOrRemove) {
      if (addOrRemove == null) {
        addOrRemove = this.addDate;
      }
      this.$els.find('.day.drag').removeClass('drag');
      this._betweenDate(from, to, true, addOrRemove);
      return this.showSelected();
    };

    Scheduler.prototype.getSelection = function() {
      var sel;
      sel = this._selected;
      return Object.keys(sel).map(function(key) {
        return sel[key];
      }).sort(function(a, b) {
        return a.getTime() - b.getTime();
      });
    };

    Scheduler.prototype.setSelection = function(selection) {
      this._selected = {};
      if (selection) {
        if (!Array.isArray(selection)) {
          selection = [selection];
        }
        selection.forEach(this.addDate.bind(this));
      }
      return this.showSelected();
    };

    Scheduler.prototype.clean = function() {
      return this.setSelection();
    };

    Scheduler.prototype.getDisabled = function() {
      var disabled;
      disabled = this._disabled;
      return Object.keys(disabled).map(function(key) {
        return disabled[key];
      });
    };

    Scheduler.prototype.setDisabled = function(disabled) {
      var date, _i, _len;
      this._disabled = {};
      if (disabled) {
        if (!Array.isArray(disabled)) {
          disabled = [disabled];
        }
        for (_i = 0, _len = disabled.length; _i < _len; _i++) {
          date = disabled[_i];
          this._disabled[this._getDateKey(date)] = date;
        }
      }
      return this.showSelected();
    };

    Scheduler.prototype.go = function(date) {
      var nextMonth;
      if (date == null) {
        date = new Date;
      }
      nextMonth = this.right.moveMonth(date, 1);
      this.left.viewDate = date;
      this.right.viewDate = nextMonth;
      this.left.fill();
      this.right.fill();
      return this.showSelected();
    };

    Scheduler.prototype.highlight = function(from, to) {
      var q, _getDateKey;
      this.$els.find('.day.drag').removeClass('drag');
      if (from && to) {
        _getDateKey = this._getDateKey;
        q = this._betweenDate(from, to, false, function(date) {
          return ".day[data-date-key=" + (_getDateKey(date)) + "]";
        });
        if (q.length) {
          this.$els.find(q.join(',')).addClass('drag');
        }
      }
      return this;
    };

    return Scheduler;

  })();

  window.schr = new Scheduler({
    el: '.scheduler'
  });

}).call(this);

/*
//@ sourceMappingURL=scheduler.map
*/
